= Home Assistant Pyscript Configuration
:toc: left
:toclevels: 3
:sectlinks:
:sectanchors:
:icons: font
:source-highlighter: rouge
:experimental:

[.lead]
Intelligent motion-activated lighting automation with time-aware behavior, gradual dimming, and environmental awareness for Home Assistant.

== Overview

This pyscript configuration provides sophisticated lighting automation that adapts to time of day, ambient light conditions, and occupancy patterns. The system uses motion sensors to trigger intelligent lighting sequences with configurable hold conditions and gradual dimming.

=== Key Features

* 🌅 **Time-Aware Automation** - Different behavior for day vs night (midnight-6am)
* 💡 **Progressive Dimming** - Multi-stage brightness reduction with configurable timing
* 🚪 **Conditional Hold** - Keep lights on based on door states or other conditions
* 🔆 **Ambient Light Awareness** - Skip activation when sufficient natural light exists
* ⏰ **Adaptive Timers** - Dynamic delay adjustment based on continued activity
* 🧪 **Development Tools** - Jupyter notebooks and IDE support for testing

== How the Lighting System Works

=== Daytime Behavior (6am - Midnight)

**Example: Motion detected in entrance at 2pm**

1. **Motion Detected** → Light turns on at maximum brightness (255)
2. **Ambient Light Check** → If illuminance > 25 lux, ignore motion and exit
3. **Initial Timer** → Starts 25-second countdown
4. **Continued Motion** → Timer extends: 25s → 30s → 35s → ... (max 120s)
5. **Timer Expires** → Begin dimming sequence:
   - 255 → 50 (wait 15s)
   - 50 → 0 (turn off)

**Branch: Hold Condition Active**
If door sensor shows 'on' state:
- Motion detection logs "Light being kept on"
- No timer starts, light stays at current brightness
- System waits for hold condition to clear

=== Nighttime Behavior (Midnight - 6am)

**Example: Motion detected in corridor at 3am**

1. **Motion Detected** → Light turns on at medium brightness (170)
2. **Ambient Light Check** → If illuminance > 25 lux, ignore motion and exit
3. **No Initial Delay** → Timer starts immediately (0-second delay for quiet operation)
4. **Continued Motion** → Extends timer but starts from higher base
5. **Timer Expires** → Begin nighttime dimming:
   - 170 → 1 (wait 0s - immediate)
   - 1 → 0 (wait 6s at minimum brightness before turning off)

**Deviation: Minimum Brightness Pause**
The system holds at brightness=1 for 6 seconds before final turn-off, allowing eyes to adjust.

=== Complex Scenario: Continuous Activity

**Example: Cooking in kitchen (evening)**

1. **7pm: Initial motion** → Light: 255, Timer: 25s
2. **7pm+20s: More motion** → Timer extends to 30s  
3. **7pm+40s: More motion** → Timer extends to 35s
4. **7pm+60s: More motion** → Timer extends to 40s
5. **...continues until max 120s**
6. **Timer finally expires** → Dimming: 255 → 50 → 0

== Configuration

=== Main Configuration

See link:config.yaml[config.yaml] for the complete configuration structure.

Key settings:
```yaml
apps:
  motion_activated_lights:
    - motion_sensor: binary_sensor.hueentrancesensor_occupancy
      light: light.entrancelight  
      timer: timer.entrance_timer
      illuminance: sensor.hueentrancesensor_illuminance
      hold_light_on_conditions:
        - entity: binary_sensor.frontdoor_contact
          expected_state: 'on'
```

=== Timing Configuration

The timing behavior is defined in link:modules/light_controls/light_controls.py[modules/light_controls/light_controls.py]:

```python
CONFIG = {
    'daytime': {
        'initial_delay': 25,        # Seconds before dimming starts
        'dimming_delay': 15,        # Seconds between dimming steps
        'brightness_levels': [255, 50, 0],  # Brightness sequence
    },
    'nighttime': {
        'initial_delay': 0,         # Immediate dimming for quiet operation
        'dimming_delay': 0,         # Instant transitions
        'brightness_levels': [170, 1, 0],   # Lower brightness sequence
        'min_brightness_delay': 6   # Pause at minimum before off
    }
}
```

== Architecture

=== Directory Structure

Based on current structure:
```
pyscript/
├── config.yaml                 # Main configuration
├── importer.py                 # Module imports and setup
├── apps/
│   ├── motion_activated_lights/    # Motion lighting app
│   └── pyscript_autocomplete/      # IDE development support
└── modules/
    ├── light_controls/             # Core lighting functions
    ├── motion_sensors/             # Manual sensor controls  
    ├── pyscript_mock/              # IDE type hints
    └── *.ipynb                     # Jupyter development notebooks
```

=== Core Components

==== Motion-Activated Lights App

Located in link:apps/motion_activated_lights/__init__.py[apps/motion_activated_lights/__init__.py], this app:

- Reads configuration from `pyscript.app_config` 
- Creates motion detection triggers for each configured sensor
- Manages hold conditions (door states, guest mode, etc.)
- Coordinates with light control functions

==== Light Control Module

Located in link:modules/light_controls/light_controls.py[modules/light_controls/light_controls.py], provides:

- Time-aware configuration (day/night modes)
- Progressive dimming logic
- Timer management and extension
- Ambient light threshold checking
- Brightness calculation and transitions

==== Motion Sensor Module

Located in link:modules/motion_sensors/motion_sensors.py[modules/motion_sensors/motion_sensors.py] for manual controls via input_text entities.

== Development

=== Interactive Testing

Use the provided Jupyter notebooks:

- link:modules/hass.ipynb[hass.ipynb] - Home Assistant entity interaction
- link:modules/test.ipynb[test.ipynb] - Function testing
- link:modules/pyscript_tutorial.ipynb[pyscript_tutorial.ipynb] - Learning examples

=== IDE Support

The link:modules/pyscript_mock/[pyscript_mock] module provides type hints and autocompletion for pyscript built-ins, enabling full IDE support during development.

== Examples

=== Adding a New Room

1. **Create timer entity** in Home Assistant
2. **Add configuration** to link:config.yaml[config.yaml]:
```yaml
- motion_sensor: binary_sensor.bedroom_motion
  light: light.bedroom_main
  timer: timer.bedroom_timer  
  illuminance: sensor.bedroom_light_level
  hold_light_on_conditions: []
```
3. **Restart pyscript** to load new configuration

=== Customizing Timing

Modify the `CONFIG` dictionary in link:modules/light_controls/light_controls.py[modules/light_controls/light_controls.py] to adjust:

- Initial delays before dimming starts
- Time between dimming steps  
- Brightness levels in the sequence
- Nighttime vs daytime behavior
- Illuminance threshold for activation

=== Debugging Motion Events

Enable debug logging to trace motion events:
```python
# In your app code
log.info(f"Motion from {motion_sensor} detected")
log.debug(f"Timer {timer} state: {timer_state}")
log.debug(f"Hold conditions active: {hold_active}")
```